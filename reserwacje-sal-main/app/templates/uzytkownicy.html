<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Użytkownicy</title>
    <link rel="stylesheet" href="static/style.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"  rel="stylesheet">
</head>
<body>
    <h1>Lista użytkowników</h1>
    <form method="GET" action="{{ url_for('main.uzytkownicy') }}">
    <input type="text" name="szukaj" placeholder="Wpisz nazwisko..." value="{{ request.args.get('szukaj', '') }}">
    <button type="submit">Szukaj</button>
    </form>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Imię</th>
                <th>Nazwisko</th>
                <th>Stopień / Tytuł</th>
                <th>Role</th>
                <th>Przedmioty</th>
                <th>Akcja</th>
            </tr>
        </thead>
        <tbody>
    {% for u in uzytkownicy %}
      {% if request.args.get('edit') == u.id_uzytkownika|string %}
      <tr>
        <form method="POST" action="{{ url_for('main.edytuj_uzytkownika', id=u.id_uzytkownika) }}">
          <td>{{ u.id_uzytkownika }}</td>
          <td><input type="text" name="imie" value="{{ u.imie }}" required></td>
          <td><input type="text" name="nazwisko" value="{{ u.nazwisko }}" required></td>
          <td><input type="text" name="stopien_naukowy" value="{{ u.stopien_naukowy }}"></td>

          <td>
    <!-- Wybór wielu ról -->
    <select name="role_ids" multiple size="3">
        {% for r in role %}
            <option value="{{ r.id_roli }}" {% if r in u.role %}selected{% endif %}>
                {{ r.nazwa_roli }}
            </option>
        {% endfor %}
    </select>
</td>

<td>
    <!-- Wybór wielu przedmiotów -->
    <select name="przedmioty_ids" multiple size="3">
        {% for p in przedmioty %}
            <option value="{{ p.id_przedmiotu }}" {% if p in u.przedmioty %}selected{% endif %}>
                {{ p.nazwa_przedmiotu }}
            </option>
        {% endfor %}
    </select>
</td>
          <td>
            <!-- Przyciski Zapisz / Anuluj -->
            <button type="submit">Zapisz</button>
            <a href="{{ url_for('main.uzytkownicy') }}">Anuluj</a>
          </td>
        </form>
      </tr>
      {% else %}
      <tr>
        <td>{{ u.id_uzytkownika }}</td>
        <td>{{ u.imie }}</td>
        <td>{{ u.nazwisko }}</td>
        <td>{{ u.stopien_naukowy }}</td>
        <td>
          {% if u.role %}
            {% for r in u.role %}
              {{ r.nazwa_roli }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            Brak ról
          {% endif %}
        </td>
        <td>
          <button class="btn btn-info btn-sm" onclick="pobierzPrzedmioty({{ u.id_uzytkownika }})">
            Wyświetl przedmioty
          </button>
        </td>
        <td>
          <form method="POST" action="{{ url_for('main.usun_uzytkownika', id=u.id_uzytkownika) }}" style="display:inline;">
            <button type="submit" onclick="return confirm('Na pewno usunąć?')">Usuń</button>
          </form>
          <a href="{{ url_for('main.uzytkownicy', edit=u.id_uzytkownika) }}">Edytuj</a>
        </td>
      </tr>
      {% endif %}
    {% endfor %}
</tbody>
    </table>
    <!-- Modal -->
<div class="modal fade" id="przedmiotyModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Przedmioty wprowadzonego użytkownika</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="lista-przedmiotow" class="list-group">
          <!-- Tutaj zostaną dodane przedmioty -->
        </ul>
      </div>
    </div>
  </div>
</div>
    <h2>Dodaj nowego użytkownika</h2>
    <form method="POST" action="{{ url_for('main.uzytkownicy') }}">
            <label for="imie">Imię:</label>
            <input type="text" name="imie" required>
        <br>
            <label for="nazwisko">Nazwisko:</label>
            <input type="text" name="nazwisko" required>
        <br>
            <label for="stopien">Stopień / tytuł:</label>
            <input type="text" name="stopien_naukowy" id="stopien_naukowy">
        <br>

        <label for="id_roli">Role:</label>
        <select name="id_roli">
            <option value="">-- Wybierz role --</option>
            {% for r in role %}
                <option value="{{ r.id_roli }}">{{ r.nazwa_roli }}</option>
            {% endfor %}
        </select>
        <button type="submit">Dodaj</button>
    </form>

    <br>
    <a href="/">Powrót do strony głównej</a>
<!-- Bootstrap JS (Bundle z Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
<script>
function pobierzPrzedmioty(uzytkownikId) {
    fetch(`/przedmioty/uzytkownik/${uzytkownikId}`)
        .then(response => response.json())
        .then(data => {
            const lista = document.getElementById('lista-przedmiotow');
            lista.innerHTML = ''; // Czyścimy poprzednią zawartość

            if (data.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = 'Brak przedmiotów.';
                lista.appendChild(li);
                return;
            }

            data.forEach(przedmiot => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = przedmiot.nazwa;
                lista.appendChild(li);
            });

            // Pokaż modal
            const modal = new bootstrap.Modal(document.getElementById('przedmiotyModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Błąd ładowania danych:', error);
            alert('Nie udało się pobrać listy przedmiotów.');
        });
}
</script>
</html>
